<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Staff | TobiForce HRMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-dark: #0f172a;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; 
            display: none; 
            overflow-x: hidden;
        }

        /* Animasi Baru */
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-table { animation: slideInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-fade { animation: fadeIn 0.4s ease-out; }

        .glass-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
        }

        /* Table Styling */
        tr { transition: all 0.2s ease; }
        tbody tr:hover { 
            background-color: #f1f5f9 !important; 
            transform: scale(1.002);
            box-shadow: inset 4px 0 0 var(--primary);
        }

        .btn-action {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-action:hover { transform: translateY(-2px); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        td { white-space: nowrap; }
    </style>
</head>
<body class="text-slate-800 no-select">

    <div class="min-h-screen flex">
        <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-[#0f172a] text-white z-50 transform -translate-x-full md:translate-x-0 md:relative transition-transform duration-500 ease-in-out flex-shrink-0 shadow-2xl">
            <div class="p-8 flex items-center space-x-3">
                <div class="bg-indigo-500 p-2.5 rounded-xl shadow-lg shadow-indigo-500/30">
                    <i class="fas fa-bolt-lightning text-xl"></i>
                </div>
                <span class="text-xl font-extrabold tracking-tighter uppercase italic">TOBIFORCE</span>
            </div>
            <nav id="dynamicNav" class="mt-4 px-4 space-y-2"></nav>
        </aside>

        <div class="flex-1 flex flex-col min-w-0">
            <header class="bg-white/70 backdrop-blur-md border-b border-slate-200 px-8 py-5 flex justify-between items-center sticky top-0 z-30">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-600 hover:bg-slate-100 rounded-lg">
                        <i class="fas fa-bars-staggered"></i>
                    </button>
                    <h2 class="text-sm font-black text-slate-400 uppercase tracking-[0.2em]">Resource Management</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-extrabold text-slate-800" id="adminNameDisplay">Admin</p>
                        <div class="flex items-center justify-end gap-1.5">
                            <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                            <span class="text-[9px] text-emerald-600 font-black uppercase tracking-widest">Active System</span>
                        </div>
                    </div>
                    <div id="avatarInit" class="w-11 h-11 bg-gradient-to-tr from-indigo-600 to-violet-600 text-white flex items-center justify-center rounded-2xl font-bold shadow-xl border-2 border-white transition-transform hover:scale-110 cursor-pointer">A</div>
                </div>
            </header>

            <main class="p-4 md:p-10 space-y-6">
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 animate-fade">
                    <div class="flex items-center gap-5">
                        <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center shadow-sm border border-slate-200">
                            <i class="fas fa-users-gear text-2xl text-indigo-600"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-black text-slate-900 tracking-tight">Database Staff</h1>
                            <p class="text-[11px] text-slate-400 uppercase tracking-[0.1em] font-bold flex items-center gap-2" id="syncStatus">
                                <i class="fas fa-circle-notch fa-spin"></i> Syncing Engine...
                            </p>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                        <div class="relative group">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Cari data staff..." 
                                class="w-full md:w-72 pl-11 pr-4 py-3 bg-white border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none text-sm font-semibold transition-all shadow-sm" />
                        </div>
                        <a href="register.html" class="flex items-center gap-2 px-6 py-3 bg-slate-900 text-white rounded-2xl font-black text-[11px] uppercase tracking-widest hover:bg-indigo-600 shadow-xl shadow-slate-200 transition-all active:scale-95">
                            <i class="fas fa-plus"></i> <span class="hidden sm:inline">Tambah Staff</span>
                        </a>
                    </div>
                </div>

                <div class="glass-card rounded-[2.5rem] overflow-hidden animate-table">
                    <div class="overflow-x-auto">
                        <table id="tabelStaff" class="w-full text-left border-collapse">
                            <thead class="bg-slate-50/50 text-slate-400 uppercase text-[10px] font-black tracking-widest border-b border-slate-100">
                                <tr id="theadRow"></tr>
                            </thead>
                            <tbody id="tbody" class="divide-y divide-slate-100 text-sm">
                                </tbody>
                        </table>
                    </div>

                    <div class="px-10 py-6 flex flex-col sm:row items-center justify-between gap-4 bg-white/50 border-t border-slate-100">
                        <div class="px-4 py-2 bg-slate-100 rounded-full text-[10px] text-slate-500 font-black uppercase tracking-tighter">
                            Record Count: <span class="text-indigo-600" id="totalData">0</span> Employees
                        </div>
                        <div class="flex items-center gap-1" id="paginationControls"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 z-[60] hidden transition-all duration-300">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm animate-fade" onclick="tutupModal('detailModal')"></div>
            <div class="bg-white rounded-[3rem] w-full max-w-lg relative z-10 overflow-hidden shadow-2xl animate-table">
                <div class="p-10 bg-[#0f172a] text-white flex justify-between items-center relative overflow-hidden">
                    <div class="relative z-10">
                        <h3 class="text-2xl font-black tracking-tight">Staff Information</h3>
                        <p class="text-indigo-400 text-[10px] uppercase tracking-[0.2em] font-black mt-1">Verified Personnel Data</p>
                    </div>
                    <i class="fas fa-id-card absolute -right-4 -bottom-4 text-8xl opacity-10"></i>
                    <button onclick="tutupModal('detailModal')" class="relative z-10 w-12 h-12 rounded-2xl bg-white/10 flex items-center justify-center hover:bg-rose-500 transition-all group">
                        <i class="fas fa-times group-hover:rotate-90 transition-transform"></i>
                    </button>
                </div>
                <div id="detailContent" class="p-10 grid grid-cols-1 gap-5 bg-gradient-to-b from-white to-slate-50"></div>
                <div class="p-8 bg-slate-100/50 flex justify-center">
                    <button onclick="tutupModal('detailModal')" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-[11px] uppercase tracking-widest hover:shadow-xl transition-all">Close Profile View</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 z-[60] hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-md" onclick="tutupModal('editModal')"></div>
            <div class="bg-white rounded-[2.5rem] shadow-[0_30px_60px_-15px_rgba(0,0,0,0.3)] w-full max-w-md relative z-10 overflow-hidden animate-table">
                <div class="p-8 border-b flex justify-between items-center bg-white">
                    <div>
                        <h3 class="font-black text-slate-900 text-lg">Modify Data</h3>
                        <p class="text-xs text-slate-400 font-medium italic">Update staff record details</p>
                    </div>
                    <button onclick="tutupModal('editModal')" class="text-slate-300 hover:text-rose-500 transition-colors"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div id="dynamicInputs" class="p-8 space-y-5 max-h-[55vh] overflow-y-auto"></div>
                <div class="p-8 bg-slate-50 border-t flex gap-3">
                    <button id="btnSimpan" onclick="simpanEdit()" class="flex-1 py-4 bg-indigo-600 text-white font-black text-[11px] uppercase tracking-widest rounded-2xl shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all active:scale-95">Push Updates</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../navbar.js"></script>
    <script>
        const STAFF_CACHE_KEY = "tobiforce_staff_data";
        const allowedHeaders = ["nama lengkap", "jenis kelamin", "umur", "jabatan", "no hp"];
        let allData = [], filteredData = [], currentHeaders = [], currentPage = 1;
        const rowsPerPage = 10;

        if (localStorage.getItem('userRole') !== 'admin') { 
            window.location.href = "../index.html"; 
        } else { 
            document.body.style.display = "block";
            const name = localStorage.getItem('userName') || "Admin";
            document.getElementById('adminNameDisplay').innerText = name;
            document.getElementById('avatarInit').innerText = name.charAt(0).toUpperCase();
        }

        function formatTglTampilan(val) {
            if (!val || val === '-') return '-';
            const date = new Date(val);
            return isNaN(date.getTime()) ? val : date.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
        }

        function formatTglInput(val) {
            if (!val) return '';
            const date = new Date(val);
            return isNaN(date.getTime()) ? '' : date.toISOString().split('T')[0];
        }

        async function initStaffData(force = false) {
            const statusE = document.getElementById('syncStatus');
            const cached = sessionStorage.getItem(STAFF_CACHE_KEY);

            if (!force && cached) {
                renderAll(JSON.parse(cached));
                statusE.innerHTML = `<span class="w-2 h-2 bg-emerald-500 rounded-full inline-block"></span> DB SYNCHRONIZED (LOCAL)`;
                return;
            }

            statusE.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> FETCHING FROM CLOUD...`;
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getStaff`);
                const hasil = await res.json();
                if (hasil.status === 'sukses') {
                    sessionStorage.setItem(STAFF_CACHE_KEY, JSON.stringify(hasil));
                    renderAll(hasil);
                    statusE.innerHTML = `<span class="w-2 h-2 bg-emerald-500 rounded-full inline-block"></span> SYSTEM ONLINE`;
                }
            } catch (e) { statusE.innerHTML = `<span class="text-rose-500">ENGINE OFFLINE</span>`; }
        }

        function renderAll(hasil) {
            currentHeaders = hasil.headers;
            allData = hasil.rows;
            filteredData = [...allData];
            renderHeader();
            renderTable();
        }

        function renderHeader() {
            let html = `<th class="px-10 py-5 text-center w-16">ID</th>`;
            currentHeaders.forEach(h => {
                if (allowedHeaders.includes(h.toLowerCase())) html += `<th class="px-4 py-5 font-black">${h}</th>`;
            });
            document.getElementById('theadRow').innerHTML = html + `<th class="px-10 py-5 text-center">Control</th>`;
        }

        function renderTable() {
            const tbody = document.getElementById('tbody');
            const start = (currentPage - 1) * rowsPerPage;
            const paginated = filteredData.slice(start, start + rowsPerPage);
            document.getElementById('totalData').innerText = filteredData.length;

            tbody.innerHTML = paginated.map((row, index) => {
                let cols = `<td class="px-10 py-5 text-center text-slate-400 font-bold text-xs">#${start + index + 1}</td>`;
                currentHeaders.forEach((h, idx) => {
                    const lowerH = h.toLowerCase();
                    if (allowedHeaders.includes(lowerH)) {
                        let val = row[idx] || '-';
                        if (lowerH.includes('kelamin')) {
                            const isPria = val.toLowerCase().includes('laki');
                            cols += `<td class="px-4 py-5"><span class="${isPria?'bg-indigo-50 text-indigo-600 border-indigo-100':'bg-rose-50 text-rose-600 border-rose-100'} px-3 py-1.5 rounded-xl text-[10px] font-black border uppercase tracking-tighter">${val}</span></td>`;
                        } else if (lowerH.includes('tanggal') || lowerH.includes('tgl')) {
                            cols += `<td class="px-4 py-5 font-bold text-slate-600 text-xs">${formatTglTampilan(val)}</td>`;
                        } else {
                            cols += `<td class="px-4 py-5 font-bold text-slate-700 text-sm">${val}</td>`;
                        }
                    }
                });
                return `<tr>${cols}
                    <td class="px-10 py-5">
                        <div class="flex gap-2 justify-center">
                            <button onclick='bukaDetail(${JSON.stringify(row)})' class="btn-action w-9 h-9 flex items-center justify-center bg-white border border-slate-200 text-indigo-500 rounded-xl shadow-sm hover:border-indigo-500 transition-all"><i class="fas fa-expand text-xs"></i></button>
                            <button onclick='bukaEdit(${JSON.stringify(row)})' class="btn-action w-9 h-9 flex items-center justify-center bg-white border border-slate-200 text-amber-500 rounded-xl shadow-sm hover:border-amber-500 transition-all"><i class="fas fa-pen-nib text-xs"></i></button>
                            <button onclick='hapusData("${row[0]}")' class="btn-action w-9 h-9 flex items-center justify-center bg-white border border-slate-200 text-rose-500 rounded-xl shadow-sm hover:border-rose-500 transition-all"><i class="fas fa-trash-can text-xs"></i></button>
                        </div>
                    </td></tr>`;
            }).join('');
            renderPagination();
        }

        // Logic functions remain the same as your functional original...
        function bukaDetail(row) {
            document.getElementById('detailContent').innerHTML = currentHeaders.map((h, i) => {
                let val = row[i] || '-';
                if (h.toLowerCase().includes('tanggal') || h.toLowerCase().includes('tgl')) val = formatTglTampilan(val);
                return `<div class="flex flex-col border-b border-slate-100 pb-3">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">${h}</span>
                    <span class="text-sm font-extrabold text-slate-800">${val}</span>
                </div>`;
            }).join('');
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function bukaEdit(row) {
            document.getElementById('dynamicInputs').innerHTML = currentHeaders.map((h, i) => {
                const lowerH = h.toLowerCase();
                const isDate = lowerH.includes('tanggal') || lowerH.includes('tgl');
                let val = row[i] || '';
                if (isDate && val) val = formatTglInput(val);

                return `<div class="group">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 block mb-2 transition-colors group-focus-within:text-indigo-600">${h}</label>
                    <input type="${isDate?'date':'text'}" id="input_${h}" value="${val}" ${i===0?'disabled bg-slate-50 border-dashed':''} 
                        class="w-full px-5 py-4 bg-white border-2 border-slate-100 rounded-2xl font-bold text-sm focus:border-indigo-500 outline-none transition-all">
                </div>`;
            }).join('');
            document.getElementById('editModal').classList.remove('hidden');
        }

        async function simpanEdit() {
            const btn = document.getElementById('btnSimpan');
            btn.disabled = true; btn.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-2"></i> Synching...`;
            const payload = { action: 'updateStaff', username: document.getElementById(`input_${currentHeaders[0]}`).value };
            currentHeaders.forEach((h, i) => { if(i > 0) payload[h] = document.getElementById(`input_${h}`).value; });
            try {
                const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
                if ((await res.json()).status === 'sukses') {
                    sessionStorage.removeItem(STAFF_CACHE_KEY);
                    tutupModal('editModal');
                    initStaffData(true);
                }
            } catch (e) { alert("Server Error"); }
            finally { btn.disabled = false; btn.innerText = "Push Updates"; }
        }

        async function hapusData(username) {
            if (!confirm(`Hapus permanen data ${username}?`)) return;
            try {
                const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteStaff', username: username }) });
                if ((await res.json()).status === 'sukses') {
                    sessionStorage.removeItem(STAFF_CACHE_KEY);
                    initStaffData(true);
                }
            } catch (e) { alert("Server Error"); }
        }

        function filterTable() {
            const q = document.getElementById("searchInput").value.toLowerCase();
            filteredData = allData.filter(r => r.some(c => c && c.toString().toLowerCase().includes(q)));
            currentPage = 1; renderTable();
        }

        function renderPagination() {
            const total = Math.ceil(filteredData.length / rowsPerPage);
            document.getElementById('paginationControls').innerHTML = `
                <button onclick="movePage(-1)" class="w-10 h-10 flex items-center justify-center rounded-xl text-slate-400 hover:bg-white hover:shadow-sm disabled:opacity-20 transition-all" ${currentPage===1?'disabled':''}><i class="fas fa-chevron-left"></i></button>
                <div class="px-6 py-2 bg-white rounded-xl shadow-sm border border-slate-100"><span class="text-[11px] font-black text-slate-700 tracking-[0.2em]">${currentPage} / ${total || 1}</span></div>
                <button onclick="movePage(1)" class="w-10 h-10 flex items-center justify-center rounded-xl text-slate-400 hover:bg-white hover:shadow-sm disabled:opacity-20 transition-all" ${currentPage===total?'disabled':''}><i class="fas fa-chevron-right"></i></button>`;
        }
        function movePage(step) { currentPage += step; renderTable(); }
        function tutupModal(id) { document.getElementById(id).classList.add('hidden'); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
        
        window.onload = () => initStaffData();
    </script>
</body>
</html>